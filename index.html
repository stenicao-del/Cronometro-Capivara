<script>
    const googleScriptURL = "https://script.google.com/macros/s/AKfycbzcahO1fxsYOJsnznUs98co4OQByHxnmLkVET1F2_pUuXqf7XThRmgBXbkt9I-7NcM/exec";
    const mqttServer = 'wss://broker.hivemq.com:8884/mqtt';
    const clientId = 'web_dashboard_' + Math.random().toString(16).substr(2, 8);
    
    const TOPIC_RESULTADO_P1 = "cronometro/resultado/pista1";
    const TOPIC_RESULTADO_P2 = "cronometro/resultado/pista2";
    const TOPIC_INICIO_P1 = "cronometro/inicio/pista1";
    const TOPIC_INICIO_P2 = "cronometro/inicio/pista2";

    const client = mqtt.connect(mqttServer, { clientId: clientId });
    const connectionStatusEl = document.getElementById('connection-status');
    const pista1TimeEl = document.getElementById('pista1-time');
    const pista2TimeEl = document.getElementById('pista2-time');
    const rankingBodyEl = document.getElementById('ranking-body');
    const categoriaSelectEl = document.getElementById('categoria');
    const recordPista1TimeEl = document.getElementById('record-pista1-time');
    const recordPista2TimeEl = document.getElementById('record-pista2-time');
    const recordPista1BoxEl = document.getElementById('record-pista1-box');
    const recordPista2BoxEl = document.getElementById('record-pista2-box');
    const kingNameEl = document.getElementById('king-name');
    const kingCategoryEl = document.getElementById('king-category');
    const kingTimeEl = document.getElementById('king-time');
    let recordPista1 = Infinity;
    let recordPista2 = Infinity;

    client.on('connect', () => {
        console.log('Conectado ao broker MQTT.');
        connectionStatusEl.textContent = 'Conectado';
        connectionStatusEl.style.color = '#4CAF50';
        client.subscribe(TOPIC_RESULTADO_P1);
        client.subscribe(TOPIC_RESULTADO_P2);
        client.subscribe(TOPIC_INICIO_P1);
        client.subscribe(TOPIC_INICIO_P2);
        updateRanking();
    });

    client.on('error', (error) => {
        console.error('Erro de conexão MQTT:', error);
        connectionStatusEl.textContent = 'Erro';
        connectionStatusEl.style.color = '#F44336';
    });

    client.on('message', (topic, message) => {
        try {
            const data = JSON.parse(message.toString());
            const idCompetidor = data.id;
            const tempo = data.tempo;
            // Remover a tentativa de pegar a categoria da mensagem MQTT
            // const categoria = data.categoria;

            if (topic === TOPIC_RESULTADO_P1) {
                pista1TimeEl.textContent = tempo.toFixed(3) + "s";
                checkAndUpdateRecords(tempo, 'pista1');
                // Enviar o ID e o tempo; o Apps Script buscará a categoria
                salvarTempoNoSheet(idCompetidor, tempo, 'pista1'); 
            } else if (topic === TOPIC_RESULTADO_P2) {
                pista2TimeEl.textContent = tempo.toFixed(3) + "s";
                checkAndUpdateRecords(tempo, 'pista2');
                // Enviar o ID e o tempo; o Apps Script buscará a categoria
                salvarTempoNoSheet(idCompetidor, tempo, 'pista2');
            }
        } catch (e) {
            console.error("Mensagem MQTT inválida:", e);
        }
    });

    async function salvarTempoNoSheet(id, tempo, pista) {
        const payload = {
            action: 'salvarTempo',
            id: id,
            tempo: tempo,
            pista: pista
        };
        try {
            await fetch(googleScriptURL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: {
                    'Content-Type': 'text/plain'
                }
            });
            setTimeout(updateRanking, 2000); 
        } catch (error) {
            console.error("Erro ao salvar tempo no Google Sheet:", error);
        }
    }

    function checkAndUpdateRecords(tempo, pista) {
        if (pista === 'pista1' && tempo < recordPista1 && tempo > 0) {
            recordPista1 = tempo;
            recordPista1TimeEl.textContent = recordPista1.toFixed(3) + "s";
            recordPista1BoxEl.classList.add('new-record');
            setTimeout(() => { recordPista1BoxEl.classList.remove('new-record'); }, 3000);
        } else if (pista === 'pista2' && tempo < recordPista2 && tempo > 0) {
            recordPista2 = tempo;
            recordPista2TimeEl.textContent = recordPista2.toFixed(3) + "s";
            recordPista2BoxEl.classList.add('new-record');
            setTimeout(() => { recordPista2BoxEl.classList.remove('new-record'); }, 3000);
        }
    }

    async function updateRanking() {
        try {
            const response = await fetch(googleScriptURL);
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
            }
            const allData = await response.json();
            const inscricoesData = allData.competidores;
            const temposData = allData.tempos;

            const competidores = {};

            inscricoesData.forEach(inscricao => {
                competidores[inscricao.qr_code] = {
                    nome: inscricao.nome_competidor,
                    categoria: inscricao.categoria,
                    melhorTempoP1: Infinity,
                    melhorTempoP2: Infinity
                };
            });

            temposData.forEach(tempo => {
                const qrP1 = tempo.qr_pista1;
                const qrP2 = tempo.qr_pista2;
                if (competidores[qrP1] && tempo.tempo_pista_1 > 0 && tempo.tempo_pista_1 < competidores[qrP1].melhorTempoP1) {
                    competidores[qrP1].melhorTempoP1 = tempo.tempo_pista_1;
                }
                if (competidores[qrP2] && tempo.tempo_pista_2 > 0 && tempo.tempo_pista_2 < competidores[qrP2].melhorTempoP2) {
                    competidores[qrP2].melhorTempoP2 = tempo.tempo_pista_2;
                }
            });

            let rankingArray = Object.values(competidores).map(c => {
                const melhorTempoP1 = c.melhorTempoP1 === Infinity ? 0 : c.melhorTempoP1;
                const melhorTempoP2 = c.melhorTempoP2 === Infinity ? 0 : c.melhorTempoP2;
                const soma = (melhorTempoP1 + melhorTempoP2) || 0;
                return { ...c, melhorTempoP1, melhorTempoP2, somaMelhoresTempos: soma };
            });

            rankingArray = rankingArray.filter(c => c.melhorTempoP1 > 0 && c.melhorTempoP2 > 0);
            rankingArray.sort((a, b) => a.somaMelhoresTempos - b.somaMelhoresTempos);

            if (rankingArray.length > 0) {
                const king = rankingArray[0];
                kingNameEl.textContent = king.nome;
                kingCategoryEl.textContent = king.categoria;
                kingTimeEl.textContent = king.somaMelhoresTempos.toFixed(3) + 's';
            } else {
                kingNameEl.textContent = 'Nenhum competidor';
                kingCategoryEl.textContent = 'com tempos totais';
                kingTimeEl.textContent = '';
            }

            const categoriaSelecionada = categoriaSelectEl.value;
            const categorias = new Set(rankingArray.map(c => c.categoria).filter(c => c));
            const categoriasArray = ['TODOS', ...Array.from(categorias).sort()];
            categoriaSelectEl.innerHTML = categoriasArray.map(c => `<option value="${c}" ${c === categoriaSelecionada ? 'selected' : ''}>${c}</option>`).join('');
            
            rankingBodyEl.innerHTML = '';
            const melhorTempoTotal = rankingArray.length > 0 ? rankingArray[0].somaMelhoresTempos : 0;
            const filteredRanking = categoriaSelecionada === 'TODOS' ? rankingArray : rankingArray.filter(c => c.categoria === categoriaSelecionada);

            if (filteredRanking.length > 0) {
                let i = 1;
                filteredRanking.forEach(competidor => {
                    const row = document.createElement('tr');
                    const diferenca = competidor.somaMelhoresTempos - melhorTempoTotal;
                    row.innerHTML = `
                        <td>${i++}</td>
                        <td>${competidor.nome}</td>
                        <td>${competidor.categoria}</td>
                        <td>${competidor.melhorTempoP1 > 0 ? competidor.melhorTempoP1.toFixed(3) + 's' : 'N/A'}</td>
                        <td>${competidor.melhorTempoP2 > 0 ? competidor.melhorTempoP2.toFixed(3) + 's' : 'N/A'}</td>
                        <td>${competidor.somaMelhoresTempos > 0 ? competidor.somaMelhoresTempos.toFixed(3) + 's' : 'N/A'}</td>
                        <td>${diferenca > 0 ? '+' + diferenca.toFixed(3) + 's' : '-'}</td>
                    `;
                    rankingBodyEl.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" style="text-align: center;">Nenhum competidor com tempos registrados para ambas as pistas nesta categoria.</td>`;
                rankingBodyEl.appendChild(row);
            }
        } catch (error) {
            rankingBodyEl.innerHTML = '<tr><td colspan="7" style="color:red; text-align:center;">Erro ao carregar dados do Apps Script.</td></tr>';
            console.error('Erro:', error);
        }
    }
    
    setInterval(updateRanking, 3000);
    document.addEventListener('DOMContentLoaded', updateRanking);
</script>
